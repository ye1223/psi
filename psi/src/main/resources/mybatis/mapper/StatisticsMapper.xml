<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.roadjava.psi.mapper.StatisticMapper">


  <select id="loadTrend" resultType="java.util.Map">
    select
     a.goods_id,
     round(avg(a.buy_price),2) buyPrice,
     c.name as goodsName,
     date_format(b.purchase_date,'%Y-%m-%d') as purchaseDate
     from purchase_detail a
    left join purchase b on a.purchase_id = b.id
    left join goods c on a.goods_id = c.id
    where a.goods_id in
    <foreach item="oneItem" collection="goodsIds" separator="," open="(" close=")">
      #{oneItem}
    </foreach>
    and b.status = 1
    and date_format(b.purchase_date,'%Y-%m-%d') >= #{startDate}
    group by a.goods_id,c.name,date_format(b.purchase_date,'%Y-%m-%d')
    order by purchaseDate
  </select>

  <select id="loadSaleNum4Goods" resultType="com.roadjava.psi.bean.dto.BarDTO">
    select
      sum(a.num) yAxisValueInt,
      c.name as xAxisName
    from sale_order_detail a
    left join sale_order b on a.order_id = b.id
    left join goods c on a.goods_id = c.id
    where
    date_format(b.create_time,'%Y-%m-%d') >= #{startDate}
    and b.status = 0
    group by c.name
    order by yAxisValueInt desc
  </select>

  <select id="loadSaleAmount4Goods" resultType="com.roadjava.psi.bean.dto.BarDTO">
    select
      round(sum(a.num*a.sale_price),2) yAxisValueDouble,
      c.name as xAxisName
    from sale_order_detail a
    left join sale_order b on a.order_id = b.id
    left join goods c on a.goods_id = c.id
    where date_format(b.create_time,'%Y-%m-%d') >= #{startDate}
    and b.status = 0
    group by c.name
    order by yAxisValueDouble desc
  </select>

  <select id="supplierRetCount" resultType="java.util.Map">
    select
    b.name,
    count(distinct a.ret_id) cnt
    from return_goods_detail a
    left join supplier b on a.supplier_id = b.id
    left join return_goods c on a.ret_id = c.id
    where c.status = 1
    group by b.name
  </select>

</mapper>